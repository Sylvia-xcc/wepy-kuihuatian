"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_api=require("./../api/api.js"),_api2=_interopRequireDefault(_api),_util=require("./../utils/util.js"),_util2=_interopRequireDefault(_util),_tip=require("./../utils/tip.js"),_tip2=_interopRequireDefault(_tip),_htmlParser=require("./../components/htmlParser.js"),_htmlParser2=_interopRequireDefault(_htmlParser),_banner=require("./../components/common/banner.js"),_banner2=_interopRequireDefault(_banner),_commodity=require("./../components/common/commodity.js"),_commodity2=_interopRequireDefault(_commodity),_popup=require("./../components/common/popup.js"),_popup2=_interopRequireDefault(_popup),_loading=require("./../components/common/loading.js"),_loading2=_interopRequireDefault(_loading),_poster=require("./../components/poster.js"),_poster2=_interopRequireDefault(_poster);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(o,i){return function t(e,r){try{var a=s[e](r),n=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(n).then(function(e){t("next",e)},function(e){t("throw",e)});o(n)}("next")})}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var goodsDetail=function(){function u(){var e,t,r,a,n;_classCallCheck(this,u);for(var o=arguments.length,i=Array(o),s=0;s<o;s++)i[s]=arguments[s];return(r=a=_possibleConstructorReturn(this,(e=u.__proto__||Object.getPrototypeOf(u)).call.apply(e,[this].concat(i)))).config={navigationBarTitleText:"商品详情"},a.$repeat={},a.$props={htmlParser:{"v-bind:parserContent.sync":"content"},myBanner:{"xmlns:v-bind":"","v-bind:banner.sync":"banner","v-bind:videoUrl.sync":"videoUrl"},commodity:{"xmlns:v-bind":"","v-bind:showModal.sync":"showModal","v-bind:cartData.sync":"cartData","v-bind:attrValueList.sync":"attrValueList","v-bind:opType.sync":"opType","xmlns:v-on":""},popup:{"xmlns:v-bind":"","v-bind:showModal.sync":"showPopupFx"},loading:{"xmlns:v-bind":"","v-bind:show.sync":"showLoading",message:"疯狂加载中..."},poster:{"xmlns:v-bind":"","v-bind:drawDataList.sync":"drawDataList"}},a.$events={commodity:{"v-on:selectAttrValueTap":"selectAttrValueTap"}},a.components={htmlParser:_htmlParser2.default,myBanner:_banner2.default,commodity:_commodity2.default,popup:_popup2.default,loading:_loading2.default,poster:_poster2.default},a.data=(_defineProperty(t={showPopupFx:!1,showLoading:!0,goodsId:0,product:{},content:"",banner:[],videoUrl:"",labels:[],showModal:!1,cartData:{},attrValueList:[],opType:"buynow",timetips:[],timer:0,miaoshaojiesu:!1,vip:0,productType:0,pintuanlist:[],is_collect:0,exist:!0},"pintuanlist",[]),_defineProperty(t,"ptheight",70),_defineProperty(t,"pintuan_id",0),_defineProperty(t,"drawDataList",null),t),a.methods={buyTap:function(e){if(_util2.default.hasAuthorize()){var t=this;if(20==t.productType&&t.miaoshaojiesu)wx.showToast({title:"秒杀活动已结束",duration:2e3,mask:!0});else{var r=e.currentTarget.dataset.optype;if("cantuan"==r){console.log("-----cantuan",e);var a=e.currentTarget.dataset.id,n=e.currentTarget.dataset.uid;if(t.$parent.globalData.userInfo.id==n)return void wx.showModal({title:"警告",content:"不能参与自己的拼团！"});t.pintuan_id=a}t.opType=r,t.showModal=!t.showModal,t.$apply()}}},collectTap:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(_util2.default.hasAuthorize()){e.next=2;break}return e.abrupt("return");case 2:0==(r=this).is_collect?r.addCollect():r.cancelCollect();case 4:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)}),gohomeTap:function(){_wepy2.default.switchTab({url:"/pages/home"})},showModalFx:function(){this.showPopupFx=!this.showPopupFx,this.$apply()},posterTap:function(){this.$broadcast("onCreatePoster")}},a.events={gotoPay:function(e){console.log("======>>> 接收子组件确定购买消息",e);this.$broadcast("toPay",{value:e,pintuan_id:this.pintuan_id}),this.$apply()},onShareAppMessage:function(e){return"button"===e.from&&console.log(e.target),{title:this.product.name,path:"/pages/goods_detail?productId="+this.goodsId,success:function(){},fail:function(){}}}},_possibleConstructorReturn(a,r)}var e,t,r,a,n;return _inherits(u,_wepy2.default.page),_createClass(u,[{key:"onLoad",value:function(e){var t=this;console.log("------ options",e),t.goodsId=e.productId||0,t.showLoading=!0,t.vip=t.$parent.globalData.userInfo?t.$parent.globalData.userInfo.vip:0,t.getGoodsDetail()}},{key:"onUnload",value:function(){console.log("========> 移除计时器"),clearInterval(this.timer)}},{key:"getGoodsDetail",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,_api2.default.goodsDetail({query:{pid:t.goodsId}});case 3:return r=e.sent,console.log("====>商品详情 ",r,t.vip),1==r.data.status?(a=r.data,t.product=a.product,t.content=a.product.content,t.banner=a.product.banner,t.videoUrl=a.product.video,t.productType=Number(a.product.goods_type),t.is_collect=a.is_collect,t.labels=a.product.labels.split("\n"),t.labels=""==t.labels[0]?[]:t.labels,t.cartData={},t.cartData.goodId=t.goodsId,t.cartData.imgUrl=a.product.thumb,t.cartData.price=1==t.vip?a.product.price_vip:a.product.price_yh,t.cartData.price_old=a.product.price,t.cartData.stock=a.product.stock,t.attrValueList=a.attr_list||[]):t.exist=!1,setTimeout(function(){t.showLoading=!1,t.$apply()},1e3),t.initAttributeValue(),e.next=10,t.loadCode();case 10:return t.drawDataList=_util2.default.getDrawCanvasData({name:t.product.name,desc:t.product.intro,photo:t.product.thumb,price:t.product.price_yh,price_yj:t.product.price}),e.next=13,t.loadBuyPinTuanList();case 13:t.startCount(),t.$apply(),this.$invoke("htmlParser","htmlParserNotice");case 16:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"initAttributeValue",value:function(){for(var e=0;e<this.attrValueList.length;e++)this.attrValueList[e].selectedValue="",this.attrValueList[e].selectedId=-1}},{key:"loadCode",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(t=this).$parent.globalData.userInfo||""!=t.$parent.globalData.code)return e.abrupt("return");e.next=3;break;case 3:return e.next=5,_api2.default.loadCode({query:{uid:t.$parent.globalData.userInfo.id}});case 5:200==(r=e.sent).statusCode&&(console.log("--------- 二维码",r),t.$parent.globalData.code=r.data.userinfo.sale_qrcode||""),t.$apply();case 8:case"end":return e.stop()}},e,this)})),function(){return a.apply(this,arguments)})},{key:"loadBuyPinTuanList",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(10!=(t=this).productType)return e.abrupt("return");e.next=3;break;case 3:return e.next=5,_api2.default.loadBuyPinTuanList({query:{id:t.goodsId}});case 5:r=e.sent,console.log("--------- 正在拼团数据",r),1==r.data.status&&(t.pintuanlist=r.data.data.list,t.ptheight=2<=t.pintuanlist.length?140:70),t.$apply();case 9:case"end":return e.stop()}},e,this)})),function(){return r.apply(this,arguments)})},{key:"startCount",value:function(){var e=this;e.setTick(),(20==e.productType&&!e.miaoshaojiesu||10==e.productType&&0<e.pintuanlist.length)&&(e.timer=setTimeout(function(){e.startCount()},1e3))}},{key:"setTick",value:function(){var e=this,t=(new Date).getTime();if(20==e.productType){var r=1e3*e.product.seckill_end;e.timetips=_util2.default.formatTime3(t,r),r<t&&(e.miaoshaojiesu=!0)}else for(var a=0;a<e.pintuanlist.length;a++){var n=1e3*e.pintuanlist[a].end_time,o=_util2.default.formatTime3(t,n);e.pintuanlist[a].timeTip=o[0]+":"+o[1]+":"+o[2]+":"+o[3]}e.$apply()}},{key:"addCollect",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,_api2.default.collectAdd({query:{user_id:t.$parent.globalData.userInfo.id,goods_id:t.goodsId}});case 3:r=e.sent,console.log("--------------\x3e>>> 收藏",r),1==r.data.status?(t.is_collect=1,_tip2.default.success("收藏成功")):_tip2.default.error("收藏失败"),t.$apply();case 7:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"cancelCollect",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,_api2.default.collectCancel({query:{user_id:t.$parent.globalData.userInfo.id,goods_id:t.goodsId}});case 3:r=e.sent,console.log("--------------\x3e>>> 收藏",r),1==r.data.status?(t.is_collect=0,_tip2.default.success("取消收藏成功")):_tip2.default.error("取消收藏失败"),t.$apply();case 7:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})}]),u}();Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(goodsDetail,"pages/goods_detail"));
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},_createClass=function(){function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_api=require("./../api/api.js"),_api2=_interopRequireDefault(_api),_util=require("./../utils/util.js"),_util2=_interopRequireDefault(_util),_tip=require("./../utils/tip.js"),_tip2=_interopRequireDefault(_tip);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(o,i){return function t(e,a){try{var n=s[e](a),r=n.value}catch(e){return void i(e)}if(!n.done)return Promise.resolve(r).then(function(e){t("next",e)},function(e){t("throw",e)});o(r)}("next")})}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Poster=function(){function i(){var e,t,a;_classCallCheck(this,i);for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];return(t=a=_possibleConstructorReturn(this,(e=i.__proto__||Object.getPrototypeOf(i)).call.apply(e,[this].concat(r)))).props={drawDataList:{}},a.components={},a.data={imagePath:"",maskHidden:!1,showMask:!1,canvasData:{},drawList:[],customData:{imageList:[],textList:[]},haveDrawEnd:!1},a.methods={saveAlbum:function(){var t=this,e=t.data.imagePath;console.log(e),wx.saveImageToPhotosAlbum({filePath:e,success:function(){wx.showModal({content:"图片已保存到相册，赶紧晒一下吧~",showCancel:!1,confirmText:"好的",confirmColor:"#333",success:function(e){e.confirm&&(t.maskHidden=!1,t.$apply())},fail:function(){}})}})},closeTap:function(){this.haveDrawEnd&&(this.maskHidden=!1,this.$apply())},tempTap:function(){}},a.events={onCreatePoster:function(){this.generatePaper()}},_possibleConstructorReturn(a,t)}var a;return _inherits(i,_wepy2.default.component),_createClass(i,[{key:"onLoad",value:function(){}},{key:"initData",value:function(e){this.canvasData=e.canvasData||"",this.drawList=e.content||"",this.$apply()}},{key:"generatePaper",value:function(){console.log("-------------- AAA 点击海报");var e=this;e.maskHidden=!0,e.haveDrawEnd||(_tip2.default.loading("海报生成中..."),e.initData(e.drawDataList),e.drawImgInit())}},{key:"drawImgInit",value:function(){var a=this,e=a.data,t=(e.canvasData,e.drawList),n=e.customData,r=n.imageList,o=n.textList,i=[];for(var s in t.length&&t.forEach(function(e,t){switch(e.type){case"image":case"image-local":r.push(e);break;case"text":o.push(e);break;case"line":i.push(e)}}),o)o[s].left=parseInt(o[s].left/1)||0,o[s].top=parseInt(o[s].top/1)||0,o[s].fontSize=parseInt(o[s].fontSize/1)||16,o[s].lineHeight=parseInt(o[s].lineHeight/1)||16,o[s].maxWidth=parseInt(o[s].maxWidth/1)||300;function l(t){r[t].left=parseInt(r[t].left/1)||0,r[t].top=parseInt(r[t].top/1)||0,r[t].width=parseInt(r[t].width/1)||100,r[t].height=parseInt(r[t].height/1)||100,"image"==r[t].type&&u.push(a.downLoadImg(r[t].url,r[t].comment,t).then(function(e){r[t].url=e},function(e){console.log("错误提示",e)}))}var u=[];for(var c in r)l(c);0<u.length?Promise.all(u).then(function(e){console.log("画布","init初始化完成..."),a.data.drawData=[].concat(_toConsumableArray(r),_toConsumableArray(o),i),a.beginDraw()}):(console.log("画布","init初始化完成..."),a.data.drawData=[].concat(_toConsumableArray(r),_toConsumableArray(o),i),a.beginDraw())}},{key:"downLoadImg",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(n,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(t,a){_tip2.default.loading("下载中..."),wx.downloadFile({url:n,complete:function(e){200===e.statusCode?(_tip2.default.loaded(),t(e.tempFilePath)):a(new Error("downloadFail fail"))}})}));case 1:case"end":return e.stop()}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"circleImg",value:function(e,t){var a=e.url,n=e.left,r=e.top,o=e.width,i=parseInt(o/2);t.save();var s=2*i,l=n+i,u=r+i;t.arc(l,u,i,0,2*Math.PI),t.clip(),t.drawImage(a,n,r,s,s),t.restore()}},{key:"drawImg",value:function(e,t){var a=e.url,n=void 0===a?"":a,r=e.top,o=void 0===r?0:r,i=e.left,s=void 0===i?0:i,l=e.width,u=void 0===l?50:l,c=e.height,f=void 0===c?50:c;e.shape;"circle"==e.shape?this.circleImg(e):(console.log("----\x3e>draw",e),t.drawImage(n,s,o,u,f))}},{key:"fillText",value:function(e,t){var a=e.fontSize,n=void 0===a?16:a,r=e.color,o=void 0===r?"#FFFFFF":r,i=e.content,s=e.left,l=void 0===s?0:s,u=e.top,c=void 0===u?0:u,f=e.textAlign,p=void 0===f?"center":f,d=e.lineHeight,h=void 0===d?16:d,v=e.lineMax,m=void 0===v?2:v,w=e.maxWidth,g=void 0===w?300:w,y=e.weight,_=void 0===y?"normal":y,b=i.split(""),x=c,k=1,D="";t.setFillStyle(o),t.setTextAlign(p),t.font="normal normal "+_+" "+n+"px cursive";for(var I=0;I<b.length;I++){if(D+=[b[I]],g<(t.measureText(D).width||0)){if(k===m&&I!==b.length){D=D.substring(0,D.length-1)+"...",t.fillText(D,l,x,g),D="";break}t.fillText(D,l,x,g),D="",x+=h,k++}}t.fillText(D,l,x,g)}},{key:"drawLine",value:function(e,t){var a=e.x1,n=void 0===a?0:a,r=e.x2,o=void 0===r?0:r,i=e.y1,s=void 0===i?0:i,l=e.y2,u=void 0===l?0:l,c=e.color,f=void 0===c?"#FFFFFF":c,p=e.lineHeight,d=void 0===p?1:p;t.moveTo(n,s),t.lineTo(o,u),t.setStrokeStyle(f),t.setLineWidth(d),t.stroke()}},{key:"beginDraw",value:function(){var a=this,e=a.data.drawData,t=wx.createCanvasContext("xcanvas",a);for(var n in e)switch(e[n].type){case"image":case"image-local":a.drawImg(_extends({},e[n]),t),0;break;case"text":a.fillText(_extends({},e[n]),t);break;case"line":a.drawLine(_extends({},e[n]),t)}t.draw(),console.log("beginDraw"),setTimeout(function(){wx.canvasToTempFilePath({canvasId:"xcanvas",success:function(e){var t=e.tempFilePath;console.log(e),a.imagePath=t,a.showMask=!0,a.haveDrawEnd=!0,wx.hideLoading(),a.$apply()},fail:function(e){console.log(e)}},a)},600)}}]),i}();exports.default=Poster;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_util=require("./../../utils/util.js"),_util2=_interopRequireDefault(_util),_api=require("./../../api/api.js"),_api2=_interopRequireDefault(_api),_tip=require("./../../utils/tip.js"),_tip2=_interopRequireDefault(_tip);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var i=e.apply(this,arguments);return new Promise(function(u,o){return function t(e,r){try{var a=i[e](r),n=a.value}catch(e){return void o(e)}if(!a.done)return Promise.resolve(n).then(function(e){t("next",e)},function(e){t("throw",e)});u(n)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var sureOrder=function(){function s(){var e,t,r,a,n;_classCallCheck(this,s);for(var u=arguments.length,o=Array(u),i=0;i<u;i++)o[i]=arguments[i];return(t=r=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(o)))).props={cartId:{type:String,value:""},couponId:{type:Number,value:0},optype:{type:Number,value:10},buyType:{type:String,value:"buynow"},studentInfo:{type:Object,value:null}},r.components={},r.data={hasAddress:!1,address:{},productData:[],couponId:0,coupon_list:[],totalPrice:0,juanPrice:0,realPrice:0,fastPrice:0,money:0,checkedCash:!0,paytype:"cash",remark:"",upload_pic:[],uploadUrl:"",buynow:!1,buyNum:1,productId:"",buff:"",pintuan_id:0},r.methods={switchPayType:function(e){this.checkedCash=e.detail.value,this.paytype=this.checkedCash?"cash":"offine"},seejuanTap:function(){this.coupon_list.length<=0||_wepy2.default.navigateTo({url:"/pages/use-coupon?cartId="+this.cartId+"&price="+this.totalPrice+"&buyNow="+this.buynow})},submitTap:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this,console.log("---",r.paytype),r.hasAddress){e.next=5;break}return _wepy2.default.showToast({title:"添加收货地址！！",duration:2e3}),e.abrupt("return");case 5:if("cash"!=r.paytype){e.next=14;break}if(Number(r.money)<Number(r.realPrice))return e.next=9,_tip2.default.confirm("余额不足，是否前往充值？");e.next=11;break;case 9:return _wepy2.default.redirectTo({url:"/pages/chongzhi"}),e.abrupt("return");case 11:r.payNormal(),e.next=16;break;case 14:r.paytype="offline",r.payNormal();case 16:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)}),chooseImage:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,u,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this,console.log("=======> add"),e.next=4,_wepy2.default.chooseImage({count:"1"});case 4:if("chooseImage:ok"!=(a=e.sent).errMsg){e.next=16;break}for(u in n=a.tempFilePaths)r.upload_pic.push(n[u]);return e.next=10,_util2.default.uploadFileImg(r.upload_pic[0]);case 10:o=e.sent,console.log("... ",o),1==o.status&&(r.uploadUrl=o.uri),r.$apply(),e.next=17;break;case 16:_tip2.default.error("操作失败");case 17:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)}),previewImgTap:function(){wx.previewImage({current:this.upload_pic[0],urls:this.upload_pic})},deletePic:function(){this.upload_pic=[],this.uploadUrl="",this.$apply()},addressTap:function(){_wepy2.default.navigateTo({url:"/pages/student/student-list?optype=select"})}},r.events={updatePayInfo:function(e){var t=this;console.log("========>子组件接受父组件信息",e,t.couponId,t.buyType),t.hasAddress="{}"!=JSON.stringify(e.address),t.address=e.address||{},t.productData=e.product||[],t.coupon_list=e.coupon_list||[],t.totalPrice=e.price,t.fastPrice=e.express_money||0,Array.from(t.coupon_list,function(e){t.couponId==e.id&&(t.juanPrice=Number(e.reduce_money).toFixed(2))}),t.realPrice=_util2.default.accAdd(e.price,e.express_money),t.realPrice=t.totalPrice<=0?.02:t.totalPrice;var r=e.userinfo;t.money=r.money,t.$apply()},updatePinTuanPayInfo:function(e){var t=this;console.log("---------- 支付通用页面 拼团数据更新",e);var r=e.value;t.hasAddress="{}"!=JSON.stringify(r.adds),t.address=r.adds||{},t.productData=[];var a={};r.pro&&(a.name=r.pro.name,a.price=r.pro.price,a.thumb=r.pro.thumb_d,a.num=1,a.gg_name=r.matchname,t.productData.push(a)),t.totalPrice=r.price,t.fastPrice=r.express||0,t.realPrice=Number(r.price)+Number(r.express);var n=r.userinfo;t.money=n.money,t.productId=e.pId||0,t.pintuan_id=e.pintuan_id||"",t.buff=e.buff||"",t.$apply()}},_possibleConstructorReturn(r,t)}var t,e,r,a;return _inherits(s,_wepy2.default.component),_createClass(s,[{key:"onLoad",value:function(){console.log("----- onLoad",_wepy2.default.$instance.globalData.student)}},{key:"payNormal",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this,console.log("-------- 购买类型",t.buyType,t.paytype),null==t.studentInfo)return _tip2.default.toast("请选择学生信息！"),e.abrupt("return");e.next=5;break;case 5:"buypintuan"==t.buyType?t.payPintuan():t.payOrder();case 6:case"end":return e.stop()}},e,this)})),function(){return a.apply(this,arguments)})},{key:"payOrder",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t=this).studentInfo?t.studentInfo.student_id:0,a={uid:_wepy2.default.$instance.globalData.userInfo.id,pay_type:t.paytype,address_id:t.address.id,remark:t.data.remark,use_jifen:0,coupons_id:t.couponId||0,pay_prove:t.uploadUrl,student_id:r||0},"buynow"==t.buyType?(t.productId=t.productData[0].id,t.buff=t.productData[0].buff,t.buyNum=t.productData[0].num,a.pid=t.productId,a.num=t.buyNum,a.buff=t.buff):a.cart_id=t.cartId,e.next=6,_api2.default.toPay({query:a});case 6:n=e.sent,console.log("====> 购物车提交订单",n),1==n.data.status?t.payResult(n.data):n.data.msg?_tip2.default.text(n.data.msg,1e3):_tip2.default.error("提交失败");case 9:case"end":return e.stop()}},e,this)})),function(){return r.apply(this,arguments)})},{key:"payPintuan",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t=this).studentInfo?t.studentInfo.student_id:0,console.log("===>拼团支付",t.paytype,t.pintuan_id),e.next=5,_api2.default.toPayPintuan({query:{uid:_wepy2.default.$instance.globalData.userInfo.id,pro_id:t.productId,pay_type:t.paytype,pro_buff:t.buff,aid:t.address.id,remark:t.data.remark,price:t.data.realPrice,pintuan_id:t.pintuan_id,pay_prove:t.uploadUrl,student_id:r||0}});case 5:a=e.sent,console.log("--------------- pay pintuan",a),1==a.data.status?t.payResult(a.data.arr):_tip2.default.error("提交订单失败",1e3);case 8:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"payResult",value:function(e){"cash"==e.pay_type?this.paySuccess():"offline"==e.pay_type?this.paySuccess():"weixin"==e.pay_type&&this.wxpay(e)}},{key:"wxpay",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this,e.next=3,_api2.default.wxPay({order_id:t.order_id,order_sn:t.order_sn,uid:_wepy2.default.$instance.globalData.userInfo.id});case 3:1==(a=e.sent).data.status&&(t=a.data.arr,_wepy2.default.requestPayment({timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.package,signType:"MD5",paySign:t.paySign,success:function(){r.paySuccess()},fail:function(){r.payFail()}}));case 5:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"paySuccess",value:function(){_wepy2.default.showToast({title:"支付成功!",duration:1e3}),setTimeout(function(){_wepy2.default.redirectTo({url:"/pages/pay/pay-success"})},1e3)}},{key:"payFail",value:function(){_wepy2.default.showToast({title:"支付失败",duration:1e3}),setTimeout(function(){_wepy2.default.redirectTo({url:"/pages/pay/pay-fail"})},1e3)}}]),s}();exports.default=sureOrder;
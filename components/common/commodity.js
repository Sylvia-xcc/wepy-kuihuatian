"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _createClass=function(){function r(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,a){return e&&r(t.prototype,e),a&&r(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_popup=require("./popup.js"),_popup2=_interopRequireDefault(_popup),_api=require("./../../api/api.js"),_api2=_interopRequireDefault(_api),_tip=require("./../../utils/tip.js"),_tip2=_interopRequireDefault(_tip);function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _asyncToGenerator(t){return function(){var i=t.apply(this,arguments);return new Promise(function(u,o){return function e(t,a){try{var r=i[t](a),n=r.value}catch(t){return void o(t)}if(!r.done)return Promise.resolve(n).then(function(t){e("next",t)},function(t){e("throw",t)});u(n)}("next")})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var Commodity=function(){function o(){var t,e,a;_classCallCheck(this,o);for(var r=arguments.length,n=Array(r),u=0;u<r;u++)n[u]=arguments[u];return(e=a=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(n)))).props={showModal:{type:Boolean,value:!1,twoWay:!0},cartData:{type:Object,value:{}},attrValueList:{type:Array,value:[]},opType:{type:String,value:"buynow"}},a.$repeat={},a.$props={popup:{"xmlns:v-bind":"","v-bind:showModal.sync":"showModal"}},a.$events={},a.components={popup:_popup2.default},a.data={show_attr_value:!1,buynum:1},a.methods={changeNum:function(t){var e=this,a=0==t.currentTarget.dataset.alphaBeta?e.buynum-1:e.buynum+1;a<=0||(a>e.cartData.stock?_tip2.default.success("数量超出范围~",1500):(e.buynum=a,e.$apply()))},selectAttrValueTap:function(t){var e=t.currentTarget.dataset,a=e.idx,r=e.id,n=e.value,u=this;e.selectedvalue==n?(u.attrValueList[a].selectedValue="",u.attrValueList[a].selectedId=-1):(u.attrValueList[a].selectedValue=n,u.attrValueList[a].selectedId=r),u.show_attr_value=u.canFitHaveSelectedAttrValue(),u.updateRealItemData()},sureCartTap:function(){var t=this,e=t.getAttrValue(!0);if(console.log("click ",e,t.opType),!(""==e&&0<t.attrValueList.length)){var a=t.cartData.stock;t.buynum>a?_tip2.default.success("库存不够",1500):t.$emit("gotoPay",e)}},closeTap:function(){this.showModal=!this.showModal,this.$apply()}},a.events={toPay:function(t){console.log("=====> 接收到父组件支付",t);var e=this,a=t.value,r=t.pintuan_id||0;if("buynow"==e.opType)return _wepy2.default.navigateTo({url:"/pages/pay_now?pId="+e.cartData.goodId+"&buff="+a+"&buy_num="+e.buynum}),e.showModal=!e.showModal,void e.$apply();"pintuan"!=e.opType&&"cantuan"!=e.opType||(wx.navigateTo({url:"/pages/pay-pintuan?pId="+e.cartData.goodId+"&buff="+a+"&pintuan_id="+r}),e.showModal=!e.showModal,e.$apply()),"addcart"!=e.opType||e.addCart(a)}},_possibleConstructorReturn(a,e)}var t,e;return _inherits(o,_wepy2.default.component),_createClass(o,[{key:"onLoad",value:function(){this.show_attr_value=this.canFitHaveSelectedAttrValue()}},{key:"addCart",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var a,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=this,t.next=3,_api2.default.addCart({query:{uid:_wepy2.default.$instance.globalData.userInfo.id,pid:a.cartData.goodId,num:a.buynum,buff:e}});case 3:r=t.sent,console.log("======> addcart ",r),1==r.data.status&&(_tip2.default.success("加入购物车成功",1500),a.showModal=!a.showModal),a.$apply();case 7:case"end":return t.stop()}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"updateRealItemData",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,a,r,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(""==(a=(e=this).getAttrValue()))return t.abrupt("return");t.next=4;break;case 4:return t.next=6,_api2.default.goodsAttrDetail({query:{pid:e.cartData.goodId,buff:a}});case 6:if(r=t.sent,console.log("-----update attr price",r),1!=r.data.status){t.next=16;break}if(n=r.data.realdata,"[]"==JSON.stringify(n))return t.abrupt("return");t.next=12;break;case 12:e.cartData.imgUrl=!n||null==n.thumb&&""==n.thumb?e.cartData.imgUrl:n.thumb,e.cartData.price_old=n.price,e.cartData.price=1==_wepy2.default.$instance.globalData.userInfo.vip?n.price_vip:n.price_yh,e.cartData.stock=n.stock;case 16:e.$apply();case 17:case"end":return t.stop()}},t,this)})),function(){return t.apply(this,arguments)})},{key:"getAttrValue",value:function(t){for(var e=0<arguments.length&&void 0!==t&&t,a="",r=0;r<this.attrValueList.length;r++){if(this.attrValueList[r].selectedId<0)return e&&_tip2.default.success('请选择 "'+this.attrValueList[r].attr_name+'"',1500),"";a+=this.attrValueList[r].selectedId+","}return a}},{key:"canFitHaveSelectedAttrValue",value:function(){for(var t=0;t<this.attrValueList.length;t++)if(0<=this.attrValueList[t].selectedId)return!0;return!1}}]),o}();exports.default=Commodity;